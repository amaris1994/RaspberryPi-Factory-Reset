#!/bin/bash

# fail on errors, undefined variables, and errors in pipes
set -eu
set -o pipefail


# get current source dir, even if its hidden in links
# needed for full paths relative to this script
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

source "$DIR/lib/display_funcs"
source "$DIR/lib/usage.sh"
source "$DIR/lib/setup.sh"
source "$DIR/lib/utils.sh"

echo "OPTION_BASE is ${OPTION_BASE}"
echo "BASE is $BASE"

if [ ! -z "${OPTION_CLEANUP_PRE}" ]; then
  cleanup
fi

check_prerequisites
check_sources
check_distribution

echo "OPTION_DO_MAIN $OPTION_DO_MAIN"

[ -z "${OPTION_DO_MAIN}" ] || main

if [ ! -z "${OPTION_CLEANUP_POST}" ]; then
  cleanup
fi

pr_header "finished"
echo "BASE is $BASE.restore.img"
